# å•å…ƒæµ‹è¯•åˆ›å»ºå®ŒæˆæŠ¥å‘Š

## âœ… æµ‹è¯•å¥—ä»¶å·²åˆ›å»º

æˆ‘å·²ç»ä¸ºä½ çš„ FastAPI é¡¹ç›®åˆ›å»ºäº†å®Œæ•´çš„å•å…ƒæµ‹è¯•å¥—ä»¶ï¼

### ğŸ“ æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ __init__.py           # æµ‹è¯•åˆå§‹åŒ–é…ç½®
â”œâ”€â”€ conftest.py           # Pytest fixtures å’Œå…±äº«é…ç½®
â”œâ”€â”€ test_auth.py          # è®¤è¯ API æµ‹è¯• (9ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_users.py         # ç”¨æˆ·ç®¡ç† API æµ‹è¯• (8ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_profiles.py      # ç”¨æˆ·èµ„æ–™ API æµ‹è¯• (6ä¸ªæµ‹è¯•)
â”œâ”€â”€ test_posts.py         # æ–‡ç« ç®¡ç† API æµ‹è¯• (8ä¸ªæµ‹è¯•)
â””â”€â”€ test_general.py       # é€šç”¨ç«¯ç‚¹æµ‹è¯• (4ä¸ªæµ‹è¯•)
```

**æ€»è®¡ï¼š35 ä¸ªæµ‹è¯•ç”¨ä¾‹**

## ğŸ“Š æµ‹è¯•è¦†ç›–èŒƒå›´

### 1. è®¤è¯ API (`test_auth.py`)
- âœ… ç”¨æˆ·æ³¨å†Œï¼ˆæˆåŠŸ/é‡å¤ç”¨æˆ·å/é‡å¤é‚®ç®±ï¼‰
- âœ… ç”¨æˆ·ç™»å½•ï¼ˆæˆåŠŸ/é”™è¯¯å¯†ç /ä¸å­˜åœ¨çš„ç”¨æˆ·ï¼‰
- âœ… è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆè®¤è¯/æœªè®¤è¯/æ— æ•ˆä»¤ç‰Œï¼‰

### 2. ç”¨æˆ·ç®¡ç† API (`test_users.py`)
- âœ… è·å–ç”¨æˆ·åˆ—è¡¨
- âœ… åˆ›å»ºç”¨æˆ·
- âœ… è·å–æŒ‡å®šç”¨æˆ·
- âœ… æ›´æ–°ç”¨æˆ·ï¼ˆå®Œæ•´æ›´æ–°/éƒ¨åˆ†æ›´æ–°ï¼‰
- âœ… åˆ é™¤ç”¨æˆ·

### 3. ç”¨æˆ·èµ„æ–™ API (`test_profiles.py`)
- âœ… è·å–èµ„æ–™åˆ—è¡¨
- âœ… åˆ›å»ºèµ„æ–™
- âœ… è·å–æŒ‡å®šèµ„æ–™
- âœ… æ›´æ–°èµ„æ–™ï¼ˆå®Œæ•´æ›´æ–°/éƒ¨åˆ†æ›´æ–°ï¼‰
- âœ… åˆ é™¤èµ„æ–™

### 4. æ–‡ç« ç®¡ç† API (`test_posts.py`)
- âœ… è·å–æ–‡ç« åˆ—è¡¨
- âœ… åˆ›å»ºæ–‡ç« 
- âœ… è·å–æŒ‡å®šæ–‡ç« 
- âœ… æ›´æ–°æ–‡ç« ï¼ˆå®Œæ•´æ›´æ–°/éƒ¨åˆ†æ›´æ–°ï¼‰
- âœ… åˆ é™¤æ–‡ç« 
- âœ… æœªè®¤è¯è®¿é—®æµ‹è¯•

### 5. é€šç”¨ç«¯ç‚¹ (`test_general.py`)
- âœ… å¥åº·æ£€æŸ¥ `/health`
- âœ… æ ¹è·¯å¾„ `/`
- âœ… API æ–‡æ¡£ `/docs`
- âœ… OpenAPI Schema `/openapi.json`

## ğŸ¯ Fixturesï¼ˆæµ‹è¯•è¾…åŠ©å·¥å…·ï¼‰

`conftest.py` æä¾›äº†ä»¥ä¸‹fixturesï¼š

| Fixture | è¯´æ˜ |
|---------|------|
| `event_loop` | å¼‚æ­¥äº‹ä»¶å¾ªç¯ |
| `db` | æµ‹è¯•æ•°æ®åº“ï¼ˆå†…å­˜SQLiteï¼‰ |
| `client` | HTTPæµ‹è¯•å®¢æˆ·ç«¯ |
| `test_user` | æµ‹è¯•æ™®é€šç”¨æˆ· |
| `test_superuser` | æµ‹è¯•è¶…çº§ç®¡ç†å‘˜ |
| `auth_token` | æ™®é€šç”¨æˆ·JWTä»¤ç‰Œ |
| `superuser_token` | è¶…çº§ç®¡ç†å‘˜JWTä»¤ç‰Œ |
| `auth_headers` | è®¤è¯è¯·æ±‚å¤´ |
| `superuser_headers` | è¶…çº§ç®¡ç†å‘˜è¯·æ±‚å¤´ |

## ğŸš€ è¿è¡Œæµ‹è¯•

### æ–¹æ³• 1: ä½¿ç”¨æµ‹è¯•è„šæœ¬
```bash
./run_tests.sh
```

### æ–¹æ³• 2: ç›´æ¥ä½¿ç”¨ pytest
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/ -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
pytest tests/test_auth.py -v

# è¿è¡Œç‰¹å®šæµ‹è¯•æ–¹æ³•
pytest tests/test_auth.py::TestAuthAPI::test_login_success -v

# æ˜¾ç¤ºè¯¦ç»†è¾“å‡º
pytest tests/ -vv -s
```

## ğŸ“ åˆæ¬¡è¿è¡Œç»“æœ

é€šç”¨ç«¯ç‚¹æµ‹è¯•ï¼ˆ`test_general.py`ï¼‰ï¼š
```
âœ… 4/4 æµ‹è¯•å…¨éƒ¨é€šè¿‡
```

å…¶ä»–æµ‹è¯•éœ€è¦æ ¹æ®å®é™… API å®ç°è¿›è¡Œè°ƒæ•´ï¼Œä¸»è¦é—®é¢˜ï¼š
1. æŸäº›ç«¯ç‚¹çš„è¯·æ±‚/å“åº”æ ¼å¼éœ€è¦åŒ¹é…å®é™…å®ç°
2. è®¤è¯æµç¨‹å¯èƒ½éœ€è¦å¾®è°ƒ
3. ModelViewSet çš„é»˜è®¤è¡Œä¸ºéœ€è¦éªŒè¯

## ğŸ”§ é…ç½®æ–‡ä»¶

### `pytest.ini`
```ini
[tool:pytest]
asyncio_mode = auto
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*
```

### `run_tests.sh`
æµ‹è¯•è¿è¡Œè„šæœ¬ï¼Œè®¾ç½®ç¯å¢ƒå˜é‡å¹¶æ‰§è¡Œæµ‹è¯•

## ğŸ“¦ æµ‹è¯•ä¾èµ–

å·²å®‰è£…çš„ä¾èµ–ï¼š
- âœ… pytest
- âœ… pytest-asyncio
- âœ… httpx

## ğŸ’¡ ä½¿ç”¨å»ºè®®

1. **æŒç»­è¿è¡Œæµ‹è¯•**
   ```bash
   pytest tests/ --watch
   ```

2. **ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š**
   ```bash
   pytest tests/ --cov=app --cov-report=html
   ```

3. **åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•**
   ```bash
   pytest tests/ --lf
   ```

4. **å¹¶è¡Œè¿è¡Œï¼ˆéœ€è¦å®‰è£… pytest-xdistï¼‰**
   ```bash
   pytest tests/ -n auto
   ```

## ğŸ“ æµ‹è¯•æœ€ä½³å®è·µ

### 1. AAA æ¨¡å¼
```python
# Arrange - å‡†å¤‡
user_data = {"username": "test"}

# Act - æ‰§è¡Œ
response = await client.post("/api", json=user_data)

# Assert - æ–­è¨€
assert response.status_code == 200
```

### 2. ä½¿ç”¨æè¿°æ€§çš„æµ‹è¯•åç§°
```python
async def test_user_cannot_access_admin_endpoint_without_permission(self, ...):
    pass
```

### 3. æµ‹è¯•è¾¹ç•Œæƒ…å†µ
- ç©ºå€¼ã€None
- è¶…é•¿å­—ç¬¦ä¸²
- æ— æ•ˆæ•°æ®ç±»å‹
- æƒé™ä¸è¶³

## ğŸ“š ç›¸å…³æ–‡æ¡£

- è¯¦ç»†æµ‹è¯•æŒ‡å—: `docs/TESTING.md`
- FastAPIæµ‹è¯•æ–‡æ¡£: https://fastapi.tiangolo.com/tutorial/testing/
- Pytestæ–‡æ¡£: https://docs.pytest.org/

## âœ¨ ä¸‹ä¸€æ­¥

1. æ ¹æ®å®é™… API å“åº”è°ƒæ•´æµ‹è¯•æ–­è¨€
2. æ·»åŠ æ›´å¤šè¾¹ç•Œæƒ…å†µæµ‹è¯•
3. å¢åŠ é›†æˆæµ‹è¯•
4. é…ç½® CI/CD è‡ªåŠ¨è¿è¡Œæµ‹è¯•
5. æé«˜æµ‹è¯•è¦†ç›–ç‡åˆ° 80%+

## ğŸ‰ æ€»ç»“

âœ… 35 ä¸ªæµ‹è¯•ç”¨ä¾‹å·²åˆ›å»º
âœ… å®Œæ•´çš„ fixtures é…ç½®
âœ… æµ‹è¯•æ–‡æ¡£é½å…¨
âœ… è¿è¡Œè„šæœ¬å°±ç»ª
âœ… é€šç”¨ç«¯ç‚¹æµ‹è¯•å…¨éƒ¨é€šè¿‡

ç°åœ¨ä½ å¯ä»¥è¿è¡Œ `./run_tests.sh` æ¥æ‰§è¡Œæ‰€æœ‰æµ‹è¯•ï¼
